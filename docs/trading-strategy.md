# 売買戦略設計書

マルチ通貨選定ロジック、スコアリング、売買判定の詳細。

---

## マルチ通貨戦略の全体像

```mermaid
flowchart TD
    subgraph 収集["5分毎: 価格収集"]
        P1["ETH/USDT"] & P2["BTC/USDT"] & P3["XRP/USDT"] & P4["SOL/USDT"] & P5["DOGE/USDT"] & P6["AVAX/USDT"]
    end

    subgraph 分析["変動検知時: 全通貨一括分析"]
        A1["テクニカル分析<br/>RSI, MACD, SMA, BB"]
        A2["AI価格予測<br/>Chronos/モメンタム"]
        A3["センチメント<br/>CryptoPanicニュース"]
    end

    subgraph 判定["スコア比較 → 最適通貨選定"]
        S["全通貨スコアリング<br/>& ランキング"]
        D{"ポジション<br/>有無?"}
        BUY["最高スコアの通貨を<br/>BUY"]
        SELL["保有通貨のスコア<br/>SELL判定"]
        HOLD["HOLD"]
    end

    収集 -->|"変動>=0.3%<br/>or 1時間経過"| 分析
    分析 --> S
    S --> D
    D -->|"なし & スコア>=buy_threshold"| BUY
    D -->|"あり & スコア<=sell_threshold"| SELL
    D -->|"それ以外"| HOLD
```

---

## スコアリング

### 3つの分析軸

| 分析 | 重み | スコア範囲 | データソース |
|---|---|---|---|
| テクニカル | 45% | -1 〜 +1 | Binance 5分足OHLC |
| AI予測 (Chronos) | 40% | -1 〜 +1 | Binance 価格履歴 |
| センチメント | 15% | -1 〜 +1 | CryptoPanic ニュース |

```
total_score = technical × 0.45 + chronos × 0.40 + sentiment × 0.15
```

### テクニカル分析の内訳

| 指標 | 重み | 意味 |
|---|---|---|
| RSI (14) | 25% | 買われすぎ(>70)/売られすぎ(<30) |
| MACD (12,26,9) | 25% | トレンド転換シグナル |
| SMA20 vs SMA200 | 25% | ゴールデン/デッドクロス |
| Bollinger Bands (20,2) | 25% | ボラティリティと位置 |

### AI予測 (Chronos)

- **ONNX Runtime on Lambda**: Chronos-T5-Tiny を ONNX 変換し Lambda 上で直接推論。S3 からモデルをダウンロード＆ /tmp キャッシュ
- 時系列予測で±5%以上の変動予測を最大スコアに変換（12ステップ先、加重平均）
  - 暗号通貨の3時間予測窓では3%超の変動が頻発するため、±5%でスケーリング
  - これによりスコアの識別力が向上し、頻繁なクリッピングを防止
- ONNX推論失敗時の代替: **モメンタムベーススコア**
  - 短期モメンタム（5期間）× 60% + 中期モメンタム（10期間）× 40%
  - ±2%の変動で±1のスコア

### センチメント分析

**ニュースソース**: CryptoPanic Growth Plan API (v2)

```
全通貨ニュース取得 (1 API call)
  → instruments フィールドで通貨別にフィルタリング
  → 各記事に重み付け:
      直接関連ニュース: ×1.0
      BTC相関ニュース:  ×0.5 (BTC以外の通貨に適用)
      全体市場ニュース: ×0.3
  → 時間減衰: 新しいほど重み大 (1h以内=1.0, 24h=0.1)
  → スコア決定:
      投票数 ≥5: 賛否比率 × 信頼度係数
      投票数 <5:  タイトルキーワード分析（強気/弱気語検出）
      + panic_score による微調整 (±0.10)
```

**API最適化**: 全通貨ニュースを1コールで取得 + 全体市場を1コール = **計2 API calls/30分**
→ 月間約2,880コール（Growth Plan上限 3,000の範囲内）

---

## 売買判定ロジック

### 1ポジション排他制御

**制約**: 全通貨を通じて **同時に1つのポジションしか保有しない**

```
# 1. ボラティリティ適応型閾値を計算
全通貨のBB幅（ボリンジャーバンド幅）の平均を算出
vol_ratio = 平均BB幅 / 基準BB幅(3%)  ← クランプ: 0.5〜2.0
buy_threshold  = BASE_BUY(0.20) × vol_ratio
sell_threshold = BASE_SELL(-0.20) × vol_ratio

# 2. 売買判定
if ポジションなし:
    全通貨をスコア降順でランキング
    最高スコア >= buy_threshold → その通貨を買い  ← ランキングが「どの通貨を買うか」を決定
    
elif ポジションあり:
    保有通貨のスコア <= sell_threshold → 売り  ← ランキングは無関係、保有通貨のスコアのみで判定
    
else:
    HOLD
```

**ボラティリティ適応の意味**:
- **高ボラ時（BB幅 > 3%）**: 閾値を厳しく → ノイズに反応しない（例: BB幅6% → BUY閾値 +0.40）
- **低ボラ時（BB幅 < 3%）**: 閾値を緩く → 小さな確実なシグナルを拾う（例: BB幅1.5% → BUY閾値 +0.10）
- **平均時（BB幅 ≈ 3%）**: 基準閾値をそのまま使用（BUY +0.20 / SELL -0.20）

**ランキングの役割**:
- **BUY時**: 「6通貨の中でどれを買うか」を決める
- **SELL時**: 使わない（保有通貨のスコアが動的sell_threshold以下かどうかのみ）
- **Slack通知**: 市場全体の温度感を人間が把握するための可視化

**排他制御の理由**:

1. **資金効率**: Coincheck の日本円残高に応じたポジションサイジングのため、残高が少額の場合に複数通貨へ分散すると1ポジションが MIN_ORDER_JPY(¥500) に近くなり実用的でない
2. **期待値集中**: 最も期待値の高い1通貨に集中投資する方が、限られた資金では合理的
3. **リスク管理**: 暗号通貨は相関が高く（BTC↓ → 全面安）、分散しても同時に損失を被る可能性が高い

### ポジションスイッチはしない

保有中のBTCのスコアが0.1で、ETHのスコアが0.8でも、BTCを売ってETHに乗り換える**ことはしない**。

理由:
- 頻繁なスイッチはスプレッドコストが嵩む
- 「売った直後に上がる」を避ける
- SELL閾値(動的、基準-0.20)以下で初めて売却 → 明確なシグナルで行動

### スコア連動ポジションサイジング

BUYシグナル発生時、スコアの強さに応じて投資金額を調整:

| スコア | 投資比率 | 例（残高¥10,000） | 意味 |
|---|---|---|---|
| 0.45+ | 100% | ¥10,000 | 非常に強いシグナル |
| 0.35-0.45 | 75% | ¥7,500 | 強いシグナル |
| 0.25-0.35 | 50% | ¥5,000 | 中程度のシグナル |
| 0.15-0.25 | 30% | ¥3,000 | 弱いシグナル |
| 0.15未満 | 0% | - | 見送り |

**計算元**: Coincheck の日本円残高をリアルタイム取得し、スコアに応じた比率を適用
**上限**: MAX_POSITION_JPY (デフォルト ¥15,000、環境変数で変更可) で絶対額をキャップ
**下限**: MIN_ORDER_JPY (¥500) 未満は注文しない
**予備**: RESERVE_JPY (¥1,000) を常に残高に確保

---

## リスク管理

### ストップロス / テイクプロフィット

| 項目 | デフォルト値 | 説明 |
|---|---|---|
| Stop Loss | -5% | 参入価格から5%下落で損切り |
| Take Profit | +10% | 参入価格から10%上昇で利確 |

- position-monitor が5分間隔で全通貨のアクティブポジションを監視
- SL/TP はポジション作成時に設定され、ポジションレコードに保存
- トリガー時は SQS 経由で order-executor に売り指示（確実な実行を保証）

### 注文の確実性

```
aggregator → SQS → order-executor
                      ↓ (失敗時)
              自動リトライ (最大3回)
                      ↓ (3回失敗)
              DLQ → CloudWatch Alarm → Slack通知
```

---

## 分析トリガー条件

価格収集は5分間隔で全通貨を実行するが、分析（Step Functions）は常に実行されるわけではない:

| トリガー | 条件 | 理由 |
|---|---|---|
| 変動トリガー | いずれかの通貨で1時間変動率 >= 0.3% | 急変時は即座に判断 |
| 定期トリガー | いずれかの通貨で前回分析から1時間経過 | 安定時も定期チェック |

**重要**: いずれかの通貨がトリガーされた場合、**全通貨を一括分析**する。これにより、常に6通貨のスコアランキングが最新の状態で比較される。

---

## Slack通知のフォーマット

分析完了ごとにSlackに以下が通知される:

```
🟢 マルチ通貨分析: BUY

判定: BUY          対象: eth_jpy

📊 通貨ランキング（期待値順）
🥇 Ethereum:  +0.7234  ▓▓▓▓▓▓▓▓░░
    Tech: +0.812 | AI: +0.654 | Sent: +0.321
🥈 Bitcoin:   +0.4521  ▓▓▓▓▓▓▓░░░
    Tech: +0.534 | AI: +0.412 | Sent: +0.123
🥉 XRP:       +0.2100  ▓▓▓▓▓▓░░░░
    Tech: +0.312 | AI: +0.123 | Sent: -0.045
...

📍 ポジション: なし | BUY閾値: +0.200 / SELL閾値: -0.200

⚡ BUY注文をキューに送信しました (eth_jpy)
```

---

## 将来の拡張性

### 通貨の追加・削除

`TRADING_PAIRS_CONFIG` 環境変数を変更するだけで対応。Terraform の `trading_pairs_config` 変数を修正して `terraform apply` すれば完了。

```json
{
  "eth_usdt": {"binance": "ETHUSDT", "coincheck": "eth_jpy", "news": "ETH", "name": "Ethereum"},
  "sol_usdt": {"binance": "SOLUSDT", "coincheck": "sol_jpy", "news": "SOL", "name": "Solana"}
}
```

### マルチポジション化

現在は1ポジション制約だが、資金が増えた場合は以下が可能:
- `MAX_CONCURRENT_POSITIONS` 環境変数で同時保有数を制御
- 通貨間の相関を考慮した分散投資ロジック

### より大きなモデルへの移行

現在は Chronos-T5-Tiny (8Mパラメータ) を Lambda + ONNX Runtime で実行しているが、将来的に精度向上が必要な場合:
- **SageMaker Serverless**: Chronos-Small/Base を SageMaker エンドポイントで実行（要クォータ申請）
- **ECS Fargate**: Chronos-Small コンテナ ($15/月) + ALB ($5/月) = +$20/月
- いずれの場合もフォールバック（モメンタムベーススコア）は維持

---

## スコア特性と設計上の注意点

### センチメントスコアの特性

センチメントスコアは通常 **0.55〜0.65**（0-1スケール）の範囲に収まる。これはCryptoPanic上の投票データが一般的にやや強気寄りであることを反映しており、正常な動作である。

- 正規化後（-1〜+1スケール）: 約 **+0.10〜+0.30** 程度
- 重み15%のため最終スコアへの寄与: 約 **+0.015〜+0.045**
- 強いシグナル（>0.8や<0.2）が出るのは、大幅なハック、ETF承認等の重大ニュース時のみ

### AI予測スコアのスケーリング

Chronos-T5-Tiny は価格の「方向」を予測する点で優秀だが、「振幅」の予測は不安定な場合がある。±5%のスケーリング（旧±3%）は以下の理由で採用:

| スケール | BTC 3h予測 | ETH 3h予測 | 適合度 |
|---|---|---|---|
| ±3% | 頻繁にクリップ→識別力低下 | 時々クリップ | ❌ 暗号通貨には狭すぎ |
| **±5%** | **適度にスケール** | **適度にスケール** | **✅ 推奨** |
| ±10% | スコアが常に小さい | スコアが常に小さい | ❌ 反応が鈍い |

### 売りシグナルの発生条件

売りシグナルには `total_score <= sell_threshold (基準: -0.20)` が必要。典型的なシナリオ:

| テクニカル | AI予測 | センチメント | 合計スコア | 判定 |
|---|---|---|---|---|
| -0.6 | -0.5 | +0.18 | -0.443 | ✅ SELL |
| -0.3 | -0.4 | +0.15 | -0.273 | ✅ SELL |
| -0.2 | -0.2 | +0.18 | -0.143 | ❌ HOLD |
| +0.1 | -0.8 | +0.10 | -0.260 | ✅ SELL |

テクニカルとAI予測の**両方**がネガティブになることが売りの基本条件。センチメントは重み15%のため売り判定への影響は小さい。
