# 取引ロジック改善企画書

**作成日**: 2025-02-09
**ステータス**: 計画中 → 順次実装

---

## 📊 現状パフォーマンス分析

### 実績 (バグ影響28件を除く正常取引17件)

| 指標 | 値 |
|------|-----|
| 勝率 | **23.5%** (4勝/13敗) |
| 累計P/L | **¥-2,471,033** |
| プロフィットファクター | **0.08** |
| 平均利益 | ¥+53,456 (+171%) |
| 平均損失 | ¥-206,527 (-14.3%) |
| バグ起因損失 (修正済) | ¥-8,485,101 |

### 致命的パターン

1. **即時売り**: 13敗中15件が **保有5分以内で即売り** → 合計¥-2,621,632
2. **XRP偏重**: 12件/17件 = 70%がXRP、累計¥-1,657,007
3. **SL/TP未発動**: 全取引がシグナル売り。SL/TPは一度も発動していない
4. **BUY→即SELL ループ**: BUYして次サイクルですぐSELLシグナル → 往復ビンタ

### シグナル統計 (810シグナル)

- BUY: 281回 (35%), SELL: 234回 (29%), HOLD: 295回 (36%)
- BUYシグナル平均スコア: +0.309
- コンポーネント平均: Technical=+0.436, Chronos=+0.248, Sentiment=+0.090
- BUY閾値(0.20)超え → 発火率35%は高すぎる

---

## 🔧 改善項目一覧 (優先度順)

### 【P1: 即効性・高インパクト】

#### 1. MACDシグナルラインの修正
- **現状**: `signal_line = macd_line * 0.9` — 偽のシグナルライン。MACD方向と常に一致
- **問題**: EMAスプレッドチェックと同等。クロスオーバー検知不可
- **修正**: 本来のEMA(9) of MACD lineを計算
- **影響**: テクニカル重み0.45 × MACD0.25 = 全体の11%に影響
- **実装先**: `services/technical/handler.py`

#### 2. 最低保有時間 (Minimum Hold Period) ✅ 実装済
- **現状**: BUY→5分後にSELLシグナル→即損切り。13敗中ほぼ全てがこのパターン
- **修正**: BUYから最低30分は通常SELLシグナルを無視（SL/TPのみ有効）
- **影響**: 即時往復ビンタの防止
- **実装先**: `services/aggregator/handler.py`

#### 3. ボリンジャーバンド デッドゾーン解消
- **現状**: BB position 0.2〜0.8の60%範囲がスコア0
- **修正**: 線形スコア `(0.5 - bb_position) * 0.5` で全範囲グラデーション化
- **影響**: テクニカルスコアの精度向上
- **実装先**: `services/technical/handler.py`

### 【P2: 中インパクト・ロジック改善】

#### 4. Chronos スコアスケール調整
- **現状**: ±5%変動 = ±1.0だが、1時間で5%は稀。Chronosスコアは常にほぼ0
- **修正**: ±1%変動 = ±1.0 に変更
- **影響**: 40%ウェイトのChronosが実質的に機能開始
- **実装先**: `services/chronos-caller/handler.py`

#### 5. トレーリングストップ実装
- **現状**: SL=-5%, TP=+10%で固定。+9%の含み益が反転→SL発動で損失
- **修正**: 段階的SL引き上げ（+3%で建値、+5%でSL=+3%等）
- **影響**: 利益確保率向上
- **実装先**: `services/position-monitor/handler.py`

#### 6. XRP偏重防止（通貨分散ルール）
- **現状**: XRP 70%集中
- **修正**: 同一通貨の最大保有数制限(1-2ポジション)、通貨間相関チェック
- **実装先**: `services/aggregator/handler.py`, `services/order-executor/handler.py`

### 【P3: 精度向上・システム改善】

#### 7. 市場レジーム検知
- **現状**: トレンド相場もレンジ相場も同じロジック
- **修正**: ATR/ADXで相場状態判定 → ウェイト動的変更
- **実装先**: `services/technical/handler.py`, `services/aggregator/handler.py`

#### 8. テクニカル指標拡充
- **追加候補**: VWAP、ATR、出来高変化率、フィボナッチリトレースメント
- **実装先**: `services/technical/handler.py`

#### 9. BUY閾値引き上げ
- **現状**: BUY閾値0.20 → 発火率35%(高すぎ)
- **修正**: 0.30-0.35に引き上げ。0.3超えは22%、0.5超えは4.6%
- **実装先**: `services/aggregator/handler.py`

#### 10. ドローダウン制御 (サーキットブレーカー)
- **現状**: 損失が続いても止まらない
- **修正**: 日次累計損失閾値 or 連敗回数で一時停止
- **実装先**: `services/order-executor/handler.py`

---

## 推奨実装順序

```
2(最低保有時間) → 1(MACD修正) → 4(Chronosスケール) → 9(BUY閾値) 
→ 3(BBデッドゾーン) → 5(トレーリングストップ) → 6(通貨分散) 
→ 10(サーキットブレーカー) → 7(レジーム検知) → 8(指標拡充)
```

---

## 実装ログ

| 日付 | 項目 | コミット | 備考 |
|------|------|---------|------|
| 2025-02-09 | #2 最低保有時間 | - | 30分ホールドルール |
