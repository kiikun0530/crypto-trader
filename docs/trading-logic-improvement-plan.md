# 取引ロジック改善企画書

**作成日**: 2025-02-09
**ステータス**: 計画中 → 順次実装

---

## 📊 現状パフォーマンス分析

### 実績 (43件のクローズ済取引、およその半数がentry_priceバグ影響)

> ⚠️ **注意**: DynamoDB上のentry_price/amountはバグで膨張しており、
> `(exit-entry)*amount` のP/L計算は信頼できない。実際のP/Lは口座残高変動から算出。

| 指標 | 値 |
|------|-----|
| 開始資金 | **¥130,000** |
| 現在残高 | **¥約100,000** |
| 実損失 | **¥約30,000** |
| 勝率 | **9.3%** (4勝/39敗) |
| プロフィットファクター | **0.27** |
| バグ起因 (entry_price膨張, 修正済) | 約26件影響 |

### 致命的パターン

1. **即時売り**: 43件中41件が **保有5分以内で即売り**
2. **XRP偏重**: 15件/43件 = 35%がXRP
3. **SL/TP未発動**: 全取引がシグナル売り。SL/TPは一度も発動していない
4. **BUY→即SELL ループ**: BUYして次サイクルですぐSELLシグナル → 往復ビンタ

### シグナル統計 (810シグナル)

- BUY: 281回 (35%), SELL: 234回 (29%), HOLD: 295回 (36%)
- BUYシグナル平均スコア: +0.309
- コンポーネント平均: Technical=+0.436, Chronos=+0.248, Sentiment=+0.090
- BUY閾値(0.20)超え → 発火率35%は高すぎる

---

## 🔧 改善項目一覧 (優先度順)

### 【P1: 即効性・高インパクト】

#### 1. MACDシグナルラインの修正 ✅ 実装済
- **現状**: `signal_line = macd_line * 0.9` — 偽のシグナルライン。MACD方向と常に一致
- **問題**: EMAスプレッドチェックと同等。クロスオーバー検知不可
- **修正**: MACD系列全体を計算し、そのEMA(9)で正しいシグナルラインを算出
- **影響**: テクニカル重み0.45 × MACD0.25 = 全体の11%に影響
- **実装先**: `services/technical/handler.py`

#### 2. 最低保有時間 (Minimum Hold Period) ✅ 実装済
- **現状**: BUY→ 5分後にSELLシグナル→即損切り。43件中41件がこのパターン
- **修正**: BUYから最低30分は通常SELLシグナルを無視（SL/TPのみ有効）
- **影響**: 即時往復ビンタの防止
- **実装先**: `services/aggregator/handler.py`

#### 3. ボリンジャーバンド デッドゾーン解消 ✅ 実装済
- **現状**: BB position 0.2〜0.8の60%範囲がスコア0
- **修正**: 線形スコア `(0.5 - bb_position) * 2 * w_bb` で全範囲グラデーション化。バンド外は1.2倍ボーナス
- **影響**: テクニカルスコアの精度向上
- **実装先**: `services/technical/handler.py`

### 【P2: 中インパクト・ロジック改善】

#### 4. Chronos スコアスケール調整 ✅ 実装済
- **現状**: ±5%変動 = ±1.0だが、1時間で5%は稀。Chronosスコアは常にほぼ0
- **修正**: ±1%変動 = ±1.0 に変更
- **影響**: 40%ウェイトのChronosが実質的に機能開始
- **実装先**: `services/chronos-caller/handler.py`

#### 5. トレーリングストップ実装 ✅ 実装済
- **現状**: SL=-5%, TP=+10%で固定。+9%の含み益が反転→SL発動で損失
- **修正**: 含み益+3%でSL=建値、+5%でSL=+3%、+8%でSL=+6%。DynamoDB永続化+Slack通知
- **影響**: 利益確保率向上
- **実装先**: `services/position-monitor/handler.py`

#### 6. XRP偏重防止（通貨分散ルール） ✅ 実装済
- **現状**: XRP 35%集中
- **修正**: 同一通貨の最大保有数制限 MAX_POSITIONS_PER_PAIR=1（環境変数で変更可）
- **実装先**: `services/aggregator/handler.py`

### 【P3: 精度向上・システム改善】

#### 7. 市場レジーム検知 ✅ 実装済
- **現状**: トレンド相場もレンジ相場も同じロジック
- **修正**: ADXで相場状態判定。ADX>25:トレンド(MACD/SMA重視)、ADX<20:レンジ(RSI/BB重視)
- **実装先**: `services/technical/handler.py`

#### 8. テクニカル指標拡充 ✅ 実装済
- **追加済**: ADX (トレンド強度)、ATR (ボラティリティ), ATR% (価格対比)、レジーム判定
- **実装先**: `services/technical/handler.py`

#### 9. BUY閾値引き上げ ✅ 実装済
- **現状**: BUY閾値デフォルト0.20 → 発火率35%(高すぎ)
- **修正**: デフォルト0.30に引き上げ。高確信度の取引のみ実行
- **実装先**: `services/aggregator/handler.py`

#### 10. ドローダウン制御 (サーキットブレーカー) ✅ 実装済
- **現状**: 損失が続いても止まらない
- **修正**: 日次累計損失閾値 (¥15,000) or 連敗回数 (5回) でBUY停止。トリップ後6時間冷却
- **ON/OFF**: `CIRCUIT_BREAKER_ENABLED` 環境変数で切替（デフォルト: OFF）
- **その他環境変数**: `CB_DAILY_LOSS_LIMIT_JPY`, `CB_MAX_CONSECUTIVE_LOSSES`, `CB_COOLDOWN_HOURS`
- **実装先**: `services/order-executor/handler.py`

---

## 推奨実装順序

```
2(最低保有時間) → 1(MACD修正) → 4(Chronosスケール) → 9(BUY閾値) 
→ 3(BBデッドゾーン) → 5(トレーリングストップ) → 6(通貨分散) 
→ 10(サーキットブレーカー) → 7(レジーム検知) → 8(指標拡充)
```

---

## 実装ログ

| 日付 | 項目 | コミット | 備考 |
|------|------|---------|------|
| 2025-02-09 | #2 最低保有時間 | 8e582d0 | 30分ホールドルール |
| 2025-02-09 | #1 MACD修正 | - | EMA(9)シグナルライン、クロスオーバー検知可能に |
| 2025-02-09 | #4 Chronosスケール | 95ef463 | ±5%→±1%、Chronosが実質機能化 |
| 2025-02-09 | #9 BUY閾値 | - | 0.20→0.30、発火率削減 |
| 2025-02-09 | #3 BBデッドゾーン | - | 線形グラデーション+バンド外ボーナス |
| 2025-02-09 | #5 トレーリングストップ | - | +3%/+5%/+8%段階式、DB永続化 |
| 2025-02-09 | #6 通貨分散 | - | MAX_POSITIONS_PER_PAIR=1 |
| 2025-02-09 | #7 レジーム検知 | - | ADX判定、ウェイト動的変更 |
| 2025-02-09 | #8 指標拡充 | - | ADX/ATR/ATR%/レジーム追加 |
| 2025-02-09 | #10 サーキットブレーカー | - | 日次損失/連敗制御、デフォルトOFF |
