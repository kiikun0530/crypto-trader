name: Post to X on Push

on:
  push:
    branches: [main]

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests requests-oauthlib

      - name: Get commit info and post to X
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          python << 'SCRIPT'
          import os
          import subprocess
          import requests
          from requests_oauthlib import OAuth1

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—
          commit_message = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%s'],
              text=True
          ).strip()
          commit_sha = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%h'],
              text=True
          ).strip()

          print(f"Commit: {commit_sha}")
          print(f"Message: {commit_message}")

          # GitHub Models APIã§è¦ç´„
          github_token = os.environ.get('GITHUB_TOKEN', '')
          tweet = None

          try:
              resp = requests.post(
                  'https://models.inference.ai.azure.com/chat/completions',
                  headers={
                      'Authorization': f'Bearer {github_token}',
                      'Content-Type': 'application/json'
                  },
                  json={
                      'model': 'gpt-4o-mini',
                      'messages': [
                          {
                              'role': 'system',
                              'content': 'ã‚ãªãŸã¯XæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ«ãƒ¼ãƒ«ï¼šæ—¥æœ¬èªžã§æ›¸ãã€çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ã†ã€140æ–‡å­—ä»¥å†…ã€æœ€å¾Œã«ã€Œ#å€‹äººé–‹ç™º #AWS #ä»•äº‹ã»ã—ã„ã€ã‚’å¿…ãšå…¥ã‚Œã‚‹ã€ã€Œcrypto-traderæ›´æ–°ã€ã§å§‹ã‚ã‚‹'
                          },
                          {
                              'role': 'user',
                              'content': f'ä»¥ä¸‹ã®Gitã‚³ãƒŸãƒƒãƒˆã‚’XæŠ•ç¨¿ç”¨ã«å¤‰æ›:\nã‚³ãƒŸãƒƒãƒˆ: {commit_sha}\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {commit_message}'
                          }
                      ],
                      'max_tokens': 200,
                      'temperature': 0.7
                  },
                  timeout=30
              )
              if resp.status_code == 200:
                  data = resp.json()
                  tweet = data['choices'][0]['message']['content'].strip()
                  print(f"Generated tweet: {tweet}")
          except Exception as e:
              print(f"GitHub Models failed: {e}")

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if not tweet:
              tweet = f"ðŸš€ crypto-traderæ›´æ–°\n{commit_message[:80]}\n\nhttps://github.com/kiikun0530/crypto-trader\n\n#å€‹äººé–‹ç™º #AWS #ä»•äº‹ã»ã—ã„"
              print(f"Using fallback: {tweet}")

          # X APIæŠ•ç¨¿
          api_key = os.environ.get('X_API_KEY', '')
          api_secret = os.environ.get('X_API_SECRET', '')
          access_token = os.environ.get('X_ACCESS_TOKEN', '')
          access_secret = os.environ.get('X_ACCESS_SECRET', '')

          if not all([api_key, api_secret, access_token, access_secret]):
              print("X API credentials not set")
              exit(0)

          auth = OAuth1(api_key, api_secret, access_token, access_secret)

          try:
              resp = requests.post(
                  'https://api.twitter.com/2/tweets',
                  auth=auth,
                  json={'text': tweet},
                  timeout=30
              )
              print(f"X API Response: {resp.status_code}")
              print(f"Response body: {resp.text}")
              if resp.status_code == 201:
                  print("Tweet posted successfully!")
              else:
                  print("Failed to post tweet")
          except Exception as e:
              print(f"X API error: {e}")
          SCRIPT
