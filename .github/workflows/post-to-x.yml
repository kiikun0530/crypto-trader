name: Post to X on Push

on:
  push:
    branches: [main]

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit
        run: |
          echo "message<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%s" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=format:'%h')" >> $GITHUB_OUTPUT

      - name: Summarize with GitHub Models
        id: summarize
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const commitMessage = `${{ steps.commit.outputs.message }}`;
            const sha = `${{ steps.commit.outputs.sha }}`;
            
            // GitHub Models APIå‘¼ã³å‡ºã—
            const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [
                  {
                    role: 'system',
                    content: `ã‚ãªãŸã¯Xï¼ˆTwitterï¼‰æŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ï¼š
- æ—¥æœ¬èªã§æ›¸ã
- çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ã†
- 140æ–‡å­—ä»¥å†…ã«åã‚ã‚‹
- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯æœ€å¾Œã«2-3å€‹
- æŠ€è¡“çš„ãªå†…å®¹ã‚’ã‚ã‹ã‚Šã‚„ã™ã
- ã€Œcrypto-traderæ›´æ–°ã€ã§å§‹ã‚ã‚‹`
                  },
                  {
                    role: 'user',
                    content: `ä»¥ä¸‹ã®Gitã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’XæŠ•ç¨¿ç”¨ã«å¤‰æ›ã—ã¦ãã ã•ã„ï¼š

ã‚³ãƒŸãƒƒãƒˆ: ${sha}
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${commitMessage}

ãƒªãƒã‚¸ãƒˆãƒªURL: https://github.com/kiikun0530/crypto-trader`
                  }
                ],
                max_tokens: 200,
                temperature: 0.7
              })
            });
            
            if (!response.ok) {
              console.log('GitHub Models API failed, using fallback');
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªæŠ•ç¨¿
              const fallback = `ğŸš€ crypto-traderæ›´æ–°\n${commitMessage.substring(0, 80)}\n\nhttps://github.com/kiikun0530/crypto-trader\n\n#å€‹äººé–‹ç™º #AWS`;
              core.setOutput('tweet', fallback);
              return;
            }
            
            const data = await response.json();
            const tweet = data.choices[0].message.content.trim();
            console.log('Generated tweet:', tweet);
            core.setOutput('tweet', tweet);

      - name: Post to X
        uses: actions/github-script@v7
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        with:
          script: |
            const crypto = require('crypto');
            const https = require('https');
            
            const tweet = `${{ steps.summarize.outputs.tweet }}`;
            
            // OAuth 1.0aç½²åç”Ÿæˆ
            function generateOAuthSignature(method, url, params, consumerSecret, tokenSecret) {
              const sortedParams = Object.keys(params).sort().map(k => `${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`).join('&');
              const baseString = `${method}&${encodeURIComponent(url)}&${encodeURIComponent(sortedParams)}`;
              const signingKey = `${encodeURIComponent(consumerSecret)}&${encodeURIComponent(tokenSecret)}`;
              return crypto.createHmac('sha1', signingKey).update(baseString).digest('base64');
            }
            
            function generateNonce() {
              return crypto.randomBytes(16).toString('hex');
            }
            
            const url = 'https://api.twitter.com/2/tweets';
            const method = 'POST';
            const oauthParams = {
              oauth_consumer_key: process.env.X_API_KEY,
              oauth_token: process.env.X_ACCESS_TOKEN,
              oauth_signature_method: 'HMAC-SHA1',
              oauth_timestamp: Math.floor(Date.now() / 1000).toString(),
              oauth_nonce: generateNonce(),
              oauth_version: '1.0'
            };
            
            const signature = generateOAuthSignature(
              method, 
              url, 
              oauthParams, 
              process.env.X_API_SECRET, 
              process.env.X_ACCESS_SECRET
            );
            
            oauthParams.oauth_signature = signature;
            
            const authHeader = 'OAuth ' + Object.keys(oauthParams)
              .sort()
              .map(k => `${encodeURIComponent(k)}="${encodeURIComponent(oauthParams[k])}"`)
              .join(', ');
            
            const postData = JSON.stringify({ text: tweet });
            
            const options = {
              hostname: 'api.twitter.com',
              path: '/2/tweets',
              method: 'POST',
              headers: {
                'Authorization': authHeader,
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            return new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  console.log('Response status:', res.statusCode);
                  console.log('Response:', data);
                  if (res.statusCode === 201) {
                    console.log('Tweet posted successfully!');
                    resolve();
                  } else {
                    console.log('Failed to post tweet');
                    // å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æˆåŠŸæ‰±ã„ã«ã™ã‚‹
                    resolve();
                  }
                });
              });
              
              req.on('error', (e) => {
                console.log('Request error:', e.message);
                resolve(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æˆåŠŸæ‰±ã„
              });
              
              req.write(postData);
              req.end();
            });
