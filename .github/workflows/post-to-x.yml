name: Generate X Post on Push

on:
  push:
    branches: [main]

jobs:
  generate-x-post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate X post and send to Slack
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python << 'SCRIPT'
          import os
          import subprocess
          import requests
          import json

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—
          commit_message = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%s'],
              text=True
          ).strip()
          commit_sha = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%h'],
              text=True
          ).strip()

          print(f"Commit: {commit_sha}")
          print(f"Message: {commit_message}")

          # GitHub Models APIã§è¦ç´„
          github_token = os.environ.get('GITHUB_TOKEN', '')
          tweet = None

          try:
              resp = requests.post(
                  'https://models.inference.ai.azure.com/chat/completions',
                  headers={
                      'Authorization': f'Bearer {github_token}',
                      'Content-Type': 'application/json'
                  },
                  json={
                      'model': 'gpt-4o-mini',
                      'messages': [
                          {
                              'role': 'system',
                              'content': 'ã‚ãªãŸã¯XæŠ•ç¨¿ã‚’ä½œæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ«ãƒ¼ãƒ«ï¼šæ—¥æœ¬èªžã§æ›¸ãã€çµµæ–‡å­—ã‚’é©åº¦ã«ä½¿ã†ã€140æ–‡å­—ä»¥å†…ã€æœ€å¾Œã«ã€Œ#å€‹äººé–‹ç™º #AWS #ä»•äº‹ã»ã—ã„ã€ã‚’å¿…ãšå…¥ã‚Œã‚‹ã€ã€Œcrypto-traderæ›´æ–°ã€ã§å§‹ã‚ã‚‹'
                          },
                          {
                              'role': 'user',
                              'content': f'ä»¥ä¸‹ã®Gitã‚³ãƒŸãƒƒãƒˆã‚’XæŠ•ç¨¿ç”¨ã«å¤‰æ›:\nã‚³ãƒŸãƒƒãƒˆ: {commit_sha}\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {commit_message}'
                          }
                      ],
                      'max_tokens': 200,
                      'temperature': 0.7
                  },
                  timeout=30
              )
              if resp.status_code == 200:
                  data = resp.json()
                  tweet = data['choices'][0]['message']['content'].strip()
                  print(f"Generated tweet: {tweet}")
          except Exception as e:
              print(f"GitHub Models failed: {e}")

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if not tweet:
              tweet = f"ðŸš€ crypto-traderæ›´æ–°\n{commit_message[:80]}\n\nhttps://github.com/kiikun0530/crypto-trader\n\n#å€‹äººé–‹ç™º #AWS #ä»•äº‹ã»ã—ã„"
              print(f"Using fallback: {tweet}")

          # Slacké€šçŸ¥
          slack_url = os.environ.get('SLACK_WEBHOOK_URL', '')
          if not slack_url:
              print("SLACK_WEBHOOK_URL not set")
              print(f"\nðŸ“ XæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆ:\n{tweet}")
              exit(0)

          slack_message = {
              "blocks": [
                  {
                      "type": "header",
                      "text": {
                          "type": "plain_text",
                          "text": "ðŸ“ XæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ",
                          "emoji": True
                      }
                  },
                  {
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": f"*ã‚³ãƒŸãƒƒãƒˆ:* `{commit_sha}`\n*ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:* {commit_message}"
                      }
                  },
                  {
                      "type": "divider"
                  },
                  {
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": f"*ã‚³ãƒ”ãƒšã—ã¦Xã«æŠ•ç¨¿ã—ã¦ã­ðŸ‘‡*\n```{tweet}```"
                      }
                  },
                  {
                      "type": "actions",
                      "elements": [
                          {
                              "type": "button",
                              "text": {
                                  "type": "plain_text",
                                  "text": "ðŸ¦ Xã‚’é–‹ã",
                                  "emoji": True
                              },
                              "url": "https://twitter.com/intent/tweet"
                          }
                      ]
                  }
              ]
          }

          try:
              resp = requests.post(
                  slack_url,
                  json=slack_message,
                  timeout=10
              )
              print(f"Slack Response: {resp.status_code}")
              if resp.status_code == 200:
                  print("Slack notification sent!")
              else:
                  print(f"Slack failed: {resp.text}")
          except Exception as e:
              print(f"Slack error: {e}")
          SCRIPT
