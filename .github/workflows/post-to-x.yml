name: Post to X on Push

on:
  push:
    branches: [main]

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests requests-oauthlib

      - name: Generate tweet and post to X
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          python << 'SCRIPT'
          import os
          import subprocess
          import requests
          from requests_oauthlib import OAuth1

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—
          commit_message = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%s'],
              text=True
          ).strip()
          commit_sha = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%h'],
              text=True
          ).strip()

          print(f"Commit: {commit_sha}")
          print(f"Message: {commit_message}")

          # GitHub Models APIã§XæŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ
          github_token = os.environ.get('GITHUB_TOKEN', '')
          tweet = None

          SYSTEM_PROMPT = """ã‚ãªãŸã¯ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®Xï¼ˆTwitterï¼‰æŠ•ç¨¿ã‚’ä»£ç­†ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

          ã€ç›®çš„ã€‘
          - å€‹äººé–‹ç™ºã®æ´»å‹•ã‚’ç™ºä¿¡ã—ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã®æŠ€è¡“åŠ›ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«ã™ã‚‹
          - ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’æŽ¢ã—ã¦ã„ã‚‹æŽ¡ç”¨æ‹…å½“è€…ãƒ»ä¼æ¥­ã®ç›®ã«ç•™ã¾ã‚‹æŠ•ç¨¿ã«ã™ã‚‹
          - è‡ªç„¶ä½“ã§ã€æŠ€è¡“ã«å¯¾ã™ã‚‹æƒ…ç†±ãŒä¼ã‚ã‚‹ãƒˆãƒ¼ãƒ³ã«ã™ã‚‹

          ã€ãƒ«ãƒ¼ãƒ«ã€‘
          - æ—¥æœ¬èªžã§æ›¸ã
          - 140æ–‡å­—ä»¥å†…ã«åŽã‚ã‚‹ï¼ˆåŽ³å®ˆï¼‰
          - çµµæ–‡å­—ã¯1-2å€‹ã ã‘ï¼ˆä½¿ã„ã™ãŽãªã„ï¼‰
          - ã€Œcrypto-traderã€ã¨ã„ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å«ã‚ã‚‹
          - ãƒªãƒã‚¸ãƒˆãƒªURL https://github.com/kiikun0530/crypto-trader ã‚’å«ã‚ã‚‹
          - æŠ€è¡“çš„ãªå…·ä½“æ€§ã‚’å…¥ã‚Œã‚‹ï¼ˆAWS Lambda, Terraform, Python, DynamoDB, Step Functionsç­‰ï¼‰
          - å¤§ã’ã•ã«ã—ãªã„ã€‚ç­‰èº«å¤§ã§ã€ã§ã‚‚æŠ€è¡“åŠ›ãŒä¼ã‚ã‚‹ã‚ˆã†ã«
          - ç…½ã‚Šã‚„èª‡å¼µã¯çµ¶å¯¾NG

          ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆå¿…ãšæœ«å°¾ã«ä»˜ã‘ã‚‹ï¼‰ã€‘
          ä»¥ä¸‹ã‹ã‚‰3-4å€‹é¸ã‚“ã§ä»˜ã‘ã‚‹:
          #å€‹äººé–‹ç™º #AWS #Python #Terraform #ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ #ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢æŽ¡ç”¨ #ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ #ä»®æƒ³é€šè²¨

          ã€è‰¯ã„ä¾‹ã€‘
          ã€Œcrypto-traderã«ãƒ‹ãƒ¥ãƒ¼ã‚¹æ„Ÿæƒ…åˆ†æžã‚’è¿½åŠ ã€‚CryptoPanic APIâ†’Lambdaâ†’DynamoDBã§30åˆ†æ¯Žã«è‡ªå‹•åŽé›†ã™ã‚‹ä»•çµ„ã¿ã€‚å…¨éƒ¨Terraformã§ç®¡ç†ã—ã¦ã¾ã™ https://github.com/kiikun0530/crypto-trader #å€‹äººé–‹ç™º #AWS #ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€

          ã€æ‚ªã„ä¾‹ï¼ˆé¿ã‘ã‚‹ã¹ãï¼‰ã€‘
          ã€ŒðŸš€ðŸ”¥ðŸ’ªæœ€å¼·ã®ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒãƒˆä½œã‚Šã¾ã—ãŸï¼ï¼ï¼å¤©æ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ï¼#æ‹¡æ•£å¸Œæœ›ã€"""

          try:
              resp = requests.post(
                  'https://models.inference.ai.azure.com/chat/completions',
                  headers={
                      'Authorization': f'Bearer {github_token}',
                      'Content-Type': 'application/json'
                  },
                  json={
                      'model': 'gpt-4o-mini',
                      'messages': [
                          {
                              'role': 'system',
                              'content': SYSTEM_PROMPT
                          },
                          {
                              'role': 'user',
                              'content': f'ä»¥ä¸‹ã®Gitã‚³ãƒŸãƒƒãƒˆã‚’XæŠ•ç¨¿ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚\nã‚³ãƒŸãƒƒãƒˆ: {commit_sha}\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {commit_message}'
                          }
                      ],
                      'max_tokens': 250,
                      'temperature': 0.7
                  },
                  timeout=30
              )
              if resp.status_code == 200:
                  data = resp.json()
                  tweet = data['choices'][0]['message']['content'].strip()
                  # ä½™åˆ†ãªã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤åŽ»
                  if tweet.startswith('"') and tweet.endswith('"'):
                      tweet = tweet[1:-1]
                  if tweet.startswith("'") and tweet.endswith("'"):
                      tweet = tweet[1:-1]
                  print(f"Generated tweet: {tweet}")
              else:
                  print(f"GitHub Models failed: {resp.status_code} {resp.text}")
          except Exception as e:
              print(f"GitHub Models failed: {e}")

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if not tweet:
              tweet = (
                  f"crypto-traderæ›´æ–°: {commit_message[:60]}\n"
                  f"https://github.com/kiikun0530/crypto-trader\n"
                  f"#å€‹äººé–‹ç™º #AWS #ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢"
              )
              print(f"Using fallback: {tweet}")

          # X APIæŠ•ç¨¿
          api_key = os.environ.get('X_API_KEY', '')
          api_secret = os.environ.get('X_API_SECRET', '')
          access_token = os.environ.get('X_ACCESS_TOKEN', '')
          access_secret = os.environ.get('X_ACCESS_SECRET', '')

          if not all([api_key, api_secret, access_token, access_secret]):
              print("X API credentials not set, skipping post")
              print(f"\nGenerated tweet:\n{tweet}")
              exit(0)

          auth = OAuth1(api_key, api_secret, access_token, access_secret)

          try:
              resp = requests.post(
                  'https://api.twitter.com/2/tweets',
                  auth=auth,
                  json={'text': tweet},
                  timeout=30
              )
              print(f"X API Response: {resp.status_code}")
              print(f"Response body: {resp.text}")
              if resp.status_code == 201:
                  print("Tweet posted successfully!")
              else:
                  print("Failed to post tweet")
          except Exception as e:
              print(f"X API error: {e}")
          SCRIPT
