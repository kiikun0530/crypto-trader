name: Post to X on Push

on:
  push:
    branches: [main]

permissions:
  models: read

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests requests-oauthlib

      - name: Generate tweet and post to X
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          python << 'SCRIPT'
          import os
          import subprocess
          import requests
          from requests_oauthlib import OAuth1

          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—ï¼ˆä»¶å + æœ¬æ–‡ï¼‰
          commit_subject = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%s'],
              text=True
          ).strip()
          commit_body = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%b'],
              text=True
          ).strip()
          commit_sha = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%h'],
              text=True
          ).strip()

          # å·®åˆ†æƒ…å ±ï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»è¡Œæ•°ï¼‰
          try:
              diff_stat = subprocess.check_output(
                  ['git', 'diff', '--stat', 'HEAD~1', 'HEAD'],
                  text=True
              ).strip()
          except Exception:
              diff_stat = "(diff not available)"

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åä¸€è¦§
          try:
              changed_files = subprocess.check_output(
                  ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
                  text=True
              ).strip()
          except Exception:
              changed_files = ""

          print(f"Commit: {commit_sha}")
          print(f"Subject: {commit_subject}")
          print(f"Body: {commit_body[:200]}")
          print(f"Changed files: {changed_files[:300]}")

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã®å¤‰æ›´ã®ã¿ã®ã‚³ãƒŸãƒƒãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
          file_list = [f.strip() for f in changed_files.split('\n') if f.strip()]
          if all(f.startswith('.github/') for f in file_list) and file_list:
              print("Skipping: only workflow files changed, nothing to tweet about")
              exit(0)

          # GitHub Models APIã§XæŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ
          github_token = os.environ.get('GITHUB_TOKEN', '')
          tweet = None

          SYSTEM_PROMPT = """ã‚ãªãŸã¯ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®å€‹äººé–‹ç™ºæ—¥è¨˜ã‚’Xï¼ˆTwitterï¼‰ã«æŠ•ç¨¿ã™ã‚‹ä»£ç­†è€…ã§ã™ã€‚

          ã€ã‚ãªãŸã®å½¹å‰²ã€‘
          ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã¨å·®åˆ†æƒ…å ±ã‚’ã€Œå‚è€ƒè³‡æ–™ã€ã¨ã—ã¦èª­ã¿å–ã‚Šã€ãã“ã‹ã‚‰é–‹ç™ºè€…ã®æ°—æŒã¡ã‚„å­¦ã³ã‚’æƒ³åƒã—ã¦ã€
          ã€Œé–‹ç™ºè€…æœ¬äººãŒãµã¨å‘Ÿã„ãŸã‹ã®ã‚ˆã†ãªã€è‡ªç„¶ãªXæŠ•ç¨¿ã‚’ç”Ÿæˆã™ã‚‹ã€‚
          ã‚ãªãŸã®å‡ºåŠ›ã¯ã€Œã¤ã¶ã‚„ãã€ã§ã‚ã‚Šã€ã€Œå¤‰æ›´ãƒ­ã‚°ã€ã§ã¯ãªã„ã€‚

          ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
          - ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆ*.md, *.py, *.tf ç­‰ï¼‰ã‚’æŠ•ç¨¿ã«çµ¶å¯¾ã«å«ã‚ãªã„
          - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãã®ã¾ã¾ä½¿ã‚ãªã„ã€‚è‡ªåˆ†ã®è¨€è‘‰ã§è¨€ã„æ›ãˆã‚‹
          - ç®‡æ¡æ›¸ããƒ»ãƒªã‚¹ãƒˆå½¢å¼ã«ã—ãªã„ã€‚è‡ªç„¶ãªæ–‡ç« ã§æ›¸ã
          - ã€Œä¿®æ­£ã—ã¾ã—ãŸã€ã€Œæ›´æ–°ã—ã¾ã—ãŸã€ã€Œè¿½åŠ ã—ã¾ã—ãŸã€ã§çµ‚ã‚ã‚‹æ–‡ã‚’æ›¸ã‹ãªã„
          - æŠ•ç¨¿ã®è‡ªå‹•åŒ–ãƒ»ä»•çµ„ã¿è‡ªä½“ã«ã¤ã„ã¦çµ¶å¯¾ã«èªžã‚‰ãªã„ï¼ˆã€ŒXæŠ•ç¨¿ã€ã€Œãƒ„ã‚¤ãƒ¼ãƒˆç”Ÿæˆã€ã€ŒSYSTEM_PROMPTã€ã€Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€ã€ŒNGãƒ¯ãƒ¼ãƒ‰ã€ã€Œå›žé¿ã€ç­‰ï¼‰
          - TOKEN, SECRET, API_KEY, credential, password ç­‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨èªžã‚’å«ã‚ãªã„
          - é–‹ç™ºã®ä¸­èº«ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€è¨­è¨ˆã€æŠ€è¡“çš„å­¦ã³ï¼‰ã ã‘ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã™ã‚‹

          ã€æŠ•ç¨¿ã®çµ„ã¿ç«‹ã¦æ–¹ã€‘
          1. ã¾ãšã€Œãªãœã“ã®ä½œæ¥­ã‚’ã—ãŸã®ã‹ã€ã‚’1æ–‡ã§æ›¸ãï¼ˆå‹•æ©Ÿãƒ»èƒŒæ™¯ãƒ»æ°—ã¥ãï¼‰
          2. æ¬¡ã«ã€Œã‚„ã£ãŸã“ã¨ã®æœ¬è³ªã€ã‚’æŠ€è¡“çš„ã«1æ–‡ã§æ›¸ãï¼ˆå…·ä½“çš„ã ãŒç°¡æ½”ã«ï¼‰
          3. æœ€å¾Œã«ã€Œæ„Ÿæƒ³ãƒ»å­¦ã³ãƒ»æ¬¡ã¸ã®å±•æœ›ã€ã‚’1æ–‡æ·»ãˆã‚‹ï¼ˆäººé–“å‘³ã®ã‚ã‚‹ç· ã‚ï¼‰
          ã“ã®3è¦ç´ ã®ã†ã¡2ã¤ä»¥ä¸Šã‚’å«ã‚ã‚‹ã“ã¨ã€‚

          ã€ãƒˆãƒ¼ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
          - æ—¥æœ¬èªžã§æ›¸ã
          - 280æ–‡å­—ä»¥å†…ï¼ˆåŽ³å®ˆï¼‰
          - ä¸€äººç§°ã¯ä½¿ã‚ãªã„ã‹ã€Œè‡ªåˆ†ã€ã€‚ã€Œç§ã€ã¯ä½¿ã‚ãªã„
          - ç­‰èº«å¤§ã§ç´ ç›´ã€‚æŠ€è¡“ã¸ã®çœŸå‰£ã•ãŒä¼ã‚ã‚‹ãƒˆãƒ¼ãƒ³
          - çµµæ–‡å­—ã¯0-2å€‹ï¼ˆãªãã¦ã‚‚ã„ã„ï¼‰
          - æŠ€è¡“ç”¨èªžã¯æ­£ç¢ºã«ä½¿ã†ï¼ˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«åˆºã•ã‚‹å†…å®¹ã‚’å„ªå…ˆï¼‰
          - å¤§ã’ã•ãƒ»ç…½ã‚Šãƒ»è‡ªç”»è‡ªè³›ã¯çµ¶å¯¾NG
          - å‹äººã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«è©±ã—ã‹ã‘ã‚‹ã‚ˆã†ãªå£èª¿

          ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç³»ã‚³ãƒŸãƒƒãƒˆã®å ´åˆã€‘
          docsã‚„READMEã®å¤‰æ›´ã§ã‚‚ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ãŸã€ã¨ã¯æ›¸ã‹ãªã„ã€‚ä»£ã‚ã‚Šã«:
          - ãªãœãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç›´ã™å¿…è¦ãŒã‚ã£ãŸã®ã‹ï¼ˆè¨­è¨ˆå¤‰æ›´ã®çµŒç·¯ï¼‰
          - æ›¸ã„ã¦ã¦æ°—ã¥ã„ãŸè¨­è¨ˆä¸Šã®ç™ºè¦‹
          - ã€Œã‚³ãƒ¼ãƒ‰æ›¸ãã‚ˆã‚Šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒãˆã‚‹æ–¹ãŒå¤§å¤‰ã€çš„ãªé–‹ç™ºã‚ã‚‹ã‚ã‚‹
          ãªã©ã€ä½œæ¥­ã®è£ã«ã‚ã‚‹æ–‡è„ˆã‚’èªžã‚‹ã€‚

          ã€å¿…é ˆè¦ç´ ã€‘
          - ãƒªãƒã‚¸ãƒˆãƒªURL: https://github.com/kiikun0530/crypto-trader
          - ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° 2-3å€‹ï¼ˆæœ«å°¾ã«ï¼‰: #å€‹äººé–‹ç™º #AWS #Python #Terraform #ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ #ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ ã‹ã‚‰é¸æŠž

          ã€è‰¯ã„æŠ•ç¨¿ä¾‹ã€‘
          ã€ŒSageMakerã®ã‚¯ã‚©ãƒ¼ã‚¿æ‰¿èªãŒæ•°æ—¥ã‹ã‹ã‚Šãã†ã ã£ãŸã®ã§ã€Chronos-T5-Tinyã‚’ONNXã«å¤‰æ›ã—ã¦Lambdaç›´æŽ¥å®Ÿè¡Œã«åˆ‡ã‚Šæ›¿ãˆãŸã€‚çµæžœçš„ã«SageMakerä¸è¦ã§ã‚³ã‚¹ãƒˆ$8/æœˆå‰Šæ¸›ã€‚åˆ¶ç´„ãŒè‰¯ã„è¨­è¨ˆã‚’ç”Ÿã‚€ã“ã¨ã‚‚ã‚ã‚‹ https://github.com/kiikun0530/crypto-trader #å€‹äººé–‹ç™º #AWSã€

          ã€Œ6é€šè²¨åŒæ™‚åˆ†æžã™ã‚‹ã¨Lambda 18ä¸¦åˆ—ã«ãªã‚‹ã‘ã©ã€DynamoDBã®ã‚ªãƒ³ãƒ‡ãƒžãƒ³ãƒ‰ãªã‚‰å…¨ç„¶è€ãˆã‚‰ã‚Œã‚‹ã€‚æœˆ$0.30ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®ã‚³ã‚¹ãƒˆæ„Ÿè¦šãŒã ã„ã¶æŽ´ã‚ã¦ããŸ https://github.com/kiikun0530/crypto-trader #å€‹äººé–‹ç™º #ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã€

          ã€Œä¾¡æ ¼å¤‰å‹•ã®æ¤œçŸ¥çª“ã‚’Â±60ç§’â†’Â±300ç§’ã«åºƒã’ãŸã ã‘ã§ã€5åˆ†è¶³ã®ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«å¢ƒç•Œå•é¡ŒãŒè§£æ±ºã€‚åœ°å‘³ã ã‘ã©ã“ã†ã„ã†ãƒã‚°ãŒä¸€ç•ªã¤ã‚‰ã„ https://github.com/kiikun0530/crypto-trader #å€‹äººé–‹ç™º #Pythonã€

          ã€ŒSageMakerã‹ã‚‰ONNX Runtimeã«ä¹—ã‚Šæ›ãˆãŸã‚‰ã€è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åŠåˆ†ãŒå˜˜ã«ãªã£ã¦ãŸã€‚ã‚³ãƒ¼ãƒ‰ç›´ã™ã‚ˆã‚Šæ•´åˆæ€§å–ã‚‹æ–¹ãŒåœ°å‘³ã«ã¤ã‚‰ã„ https://github.com/kiikun0530/crypto-trader #å€‹äººé–‹ç™º #AWSã€

          ã€æ‚ªã„ä¾‹ï¼ˆé¿ã‘ã‚‹ã¹ãï¼‰ã€‘
          - ã€Œtrading-strategy.md: ECSå‚ç…§ã‚’ONNXã«ä¿®æ­£ã€â† ãƒ•ã‚¡ã‚¤ãƒ«åãŒå…¥ã£ã¦ã„ã‚‹
          - ã€Œcrypto-traderæ›´æ–°: XXXã‚’è¿½åŠ ã—ã¾ã—ãŸã€â† æ›´æ–°å ±å‘Šã§ã—ã‹ãªã„
          - ã€ŒðŸš€ðŸ”¥ã™ã”ã„ã®ä½œã£ãŸï¼ï¼ã€â† ç…½ã‚Š
          - ã€Œfeat: add ONNX supportã€â† ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ãã®ã¾ã¾
          - ã€Œ- xxxä¿®æ­£ - yyyæ›´æ–° - zzzè¿½åŠ ã€â† ç®‡æ¡æ›¸ãã«ãªã£ã¦ã„ã‚‹"""

          # LLMã«æ¸¡ã™ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒªãƒƒãƒãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
          body_text = commit_body if commit_body else '(ãªã—)'
          user_message = (
              "ä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‹ã‚‰XæŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n"
              "ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã ã‘ã§ãªãã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚„å·®åˆ†ã‹ã‚‰ã€Œä½•ã‚’ãªãœã‚„ã£ãŸã‹ã€ã‚’èª­ã¿å–ã£ã¦ã€é–‹ç™ºè€…ã®è¦–ç‚¹ã§èªžã£ã¦ãã ã•ã„ã€‚\n\n"
              "## ã‚³ãƒŸãƒƒãƒˆ\n"
              f"ä»¶å: {commit_subject}\n"
              "æœ¬æ–‡:\n"
              f"{body_text}\n\n"
              "## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«\n"
              f"{changed_files}\n\n"
              "## å·®åˆ†ã‚µãƒžãƒª\n"
              f"{diff_stat}"
          )

          try:
              resp = requests.post(
                  'https://models.inference.ai.azure.com/chat/completions',
                  headers={
                      'Authorization': f'Bearer {github_token}',
                      'Content-Type': 'application/json'
                  },
                  json={
                      'model': 'gpt-4o-mini',
                      'messages': [
                          {
                              'role': 'system',
                              'content': SYSTEM_PROMPT
                          },
                          {
                              'role': 'user',
                              'content': user_message
                          }
                      ],
                      'max_tokens': 350,
                      'temperature': 0.7
                  },
                  timeout=30
              )
              if resp.status_code == 200:
                  data = resp.json()
                  tweet = data['choices'][0]['message']['content'].strip()
                  # ä½™åˆ†ãªã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤åŽ»
                  if tweet.startswith('"') and tweet.endswith('"'):
                      tweet = tweet[1:-1]
                  if tweet.startswith("'") and tweet.endswith("'"):
                      tweet = tweet[1:-1]
                  print(f"Generated tweet: {tweet}")
              else:
                  print(f"GitHub Models failed: {resp.status_code} {resp.text}")
          except Exception as e:
              print(f"GitHub Models failed: {e}")

          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if not tweet:
              # ã‚³ãƒŸãƒƒãƒˆæœ¬æ–‡ãŒã‚ã‚Œã°ä½¿ã†ã€ãªã‘ã‚Œã°ä»¶åã‚’ä½¿ã†
              detail = commit_body.split('\n')[0][:80] if commit_body else commit_subject[:80]
              tweet = (
                  f"{detail}\n"
                  f"https://github.com/kiikun0530/crypto-trader\n"
                  f"#å€‹äººé–‹ç™º #AWS #ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢"
              )
              print(f"Using fallback: {tweet}")

          # X APIæŠ•ç¨¿
          api_key = os.environ.get('X_API_KEY', '')
          api_secret = os.environ.get('X_API_SECRET', '')
          access_token = os.environ.get('X_ACCESS_TOKEN', '')
          access_secret = os.environ.get('X_ACCESS_SECRET', '')

          if not all([api_key, api_secret, access_token, access_secret]):
              print("X API credentials not set, skipping post")
              print(f"\nGenerated tweet:\n{tweet}")
              exit(0)

          auth = OAuth1(api_key, api_secret, access_token, access_secret)

          try:
              resp = requests.post(
                  'https://api.twitter.com/2/tweets',
                  auth=auth,
                  json={'text': tweet},
                  timeout=30
              )
              print(f"X API Response: {resp.status_code}")
              print(f"Response body: {resp.text}")
              if resp.status_code == 201:
                  print("Tweet posted successfully!")
              else:
                  print("Failed to post tweet")
          except Exception as e:
              print(f"X API error: {e}")
          SCRIPT
