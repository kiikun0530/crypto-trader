name: Post to X on Push

on:
  push:
    branches: [main]

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests requests-oauthlib

      - name: Generate tweet and post to X
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET }}
        run: |
          python << 'SCRIPT'
          import os
          import subprocess
          import requests
          from requests_oauthlib import OAuth1

          # コミット情報取得
          commit_subject = subprocess.check_output(
              ['git', 'log', '-1', '--pretty=format:%s'],
              text=True
          ).strip()

          # 変更ファイル名一覧
          try:
              changed_files = subprocess.check_output(
                  ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
                  text=True
              ).strip()
          except Exception:
              changed_files = ""

          print(f"Subject: {commit_subject}")
          print(f"Changed files: {changed_files[:300]}")

          # ワークフロー自体の変更のみのコミットはスキップ
          file_list = [f.strip() for f in changed_files.split('\n') if f.strip()]
          if all(f.startswith('.github/') for f in file_list) and file_list:
              print("Skipping: only workflow files changed")
              exit(0)

          # シンプルなテンプレートで投稿文を生成
          tweet = (
              f"crypto-trader更新: {commit_subject}\n"
              f"https://github.com/kiikun0530/crypto-trader\n"
              f"#個人開発 #AWS #フリーランスエンジニア"
          )

          # 280文字制限チェック
          if len(tweet) > 280:
              max_subject = 280 - len("crypto-trader更新: \nhttps://github.com/kiikun0530/crypto-trader\n#個人開発 #AWS #フリーランスエンジニア")
              tweet = (
                  f"crypto-trader更新: {commit_subject[:max_subject]}...\n"
                  f"https://github.com/kiikun0530/crypto-trader\n"
                  f"#個人開発 #AWS #フリーランスエンジニア"
              )

          print(f"Tweet ({len(tweet)} chars):\n{tweet}")

          # X API投稿
          api_key = os.environ.get('X_API_KEY', '')
          api_secret = os.environ.get('X_API_SECRET', '')
          access_token = os.environ.get('X_ACCESS_TOKEN', '')
          access_secret = os.environ.get('X_ACCESS_SECRET', '')

          if not all([api_key, api_secret, access_token, access_secret]):
              print("X API credentials not set, skipping post")
              exit(0)

          auth = OAuth1(api_key, api_secret, access_token, access_secret)

          try:
              resp = requests.post(
                  'https://api.twitter.com/2/tweets',
                  auth=auth,
                  json={'text': tweet},
                  timeout=30
              )
              print(f"X API Response: {resp.status_code}")
              print(f"Response body: {resp.text}")
              if resp.status_code == 201:
                  print("Tweet posted successfully!")
              else:
                  print(f"Failed to post tweet: {resp.status_code}")
                  exit(1)
          except Exception as e:
              print(f"X API error: {e}")
              exit(1)
          SCRIPT
